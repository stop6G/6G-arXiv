<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6G-arXiv Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #050505;
            color: #ffffff;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #0ea5e9;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        text { 
            /* Specific transitions prevent hit-box lag */
            transition: opacity 0.3s, filter 0.3s, text-shadow 0.3s;
            cursor: pointer; 
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            /* Ensure pointer events are captured on the fill */
            pointer-events: visibleFill; 
        }
        text:hover { 
            opacity: 1 !important; 
            filter: brightness(1.2);
            text-shadow: 0 0 20px currentColor; 
            z-index: 10;
        }
        /* Fade out other text on hover */
        .has-hover text:not(:hover) {
            opacity: 0.3;
            filter: blur(1px);
        }

        /* Sidebar transitions */
        #details-sidebar {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .paper-card {
            transition: background-color 0.2s;
        }
        .paper-card:hover {
            background-color: rgba(255,255,255,0.03);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden relative">

    <!-- Background decorative gradients -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-900/10 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-900/10 rounded-full blur-[100px]"></div>
    </div>

    <!-- Header -->
    <header class="text-center mb-6 z-10 transition-all duration-500" id="main-header">
        <div class="flex flex-col items-center gap-3">
            <div class="flex items-center gap-3">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs font-mono text-blue-400">
                    <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                    </span>
                    LIVE DATA
                </div>
                <a href="https://stop6g.eu" target="_blank" class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs font-mono text-gray-400 hover:text-white hover:border-white/30 transition-colors">
                    stop6g.eu
                </a>
                <a id="download-link" href="#" target="_blank" title="Download CSV" class="flex items-center justify-center w-7 h-7 rounded-full bg-white/5 border border-white/10 text-gray-400 hover:text-white hover:border-white/30 transition-colors">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </a>
            </div>
            
            <h1 class="text-5xl font-bold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white via-gray-200 to-gray-500">6G-arXiv</h1>
            <p class="text-gray-400 font-light text-sm max-w-md mx-auto">Analyzing semantic patterns in arXiv submission titles</p>
        </div>
    </header>

    <!-- Main Viz Area -->
    <div id="viz-container" class="relative w-full max-w-7xl aspect-[16/9] bg-[#0a0a0a] rounded-3xl shadow-2xl border border-white/10 flex overflow-hidden backdrop-blur-sm transition-all duration-500">
        
        <!-- Loading State -->
        <div id="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 backdrop-blur-sm transition-opacity duration-500">
            <div class="loader mb-4"></div>
            <p id="status-text" class="text-sm font-mono text-blue-400">CONNECTING TO REPO...</p>
        </div>

        <!-- SVG Output -->
        <div class="flex-grow relative overflow-hidden h-full">
            <svg id="word-cloud" class="w-full h-full opacity-0 transition-opacity duration-1000"></svg>
        </div>

        <!-- Details Sidebar (Hidden by default via transform) -->
        <div id="details-sidebar" class="absolute top-0 right-0 w-full md:w-[450px] h-full bg-[#0f0f0f]/95 border-l border-white/10 backdrop-blur-md transform translate-x-full flex flex-col z-30 shadow-2xl">
            <!-- Sidebar Header -->
            <div class="p-6 border-b border-white/10 flex justify-between items-start bg-[#0f0f0f]">
                <div>
                    <div class="text-xs text-blue-400 font-mono mb-1">SELECTED TOPIC</div>
                    <h2 id="sidebar-title" class="text-3xl font-bold text-white capitalize">Topic</h2>
                    <p id="sidebar-count" class="text-sm text-gray-400 mt-1">Found in 12 papers</p>
                </div>
                <button id="close-sidebar" class="p-2 hover:bg-white/10 rounded-full transition-colors">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Sidebar Content -->
            <div id="sidebar-content" class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- Papers will be injected here -->
            </div>
        </div>
    </div>

    <!-- Footer / Stats -->
    <div class="mt-6 flex flex-wrap justify-center gap-8 text-xs text-gray-500 font-mono">
        <div id="stat-papers">TOTAL PAPERS: 0</div>
        <div id="stat-count">WORDS: 0</div>
        <div id="stat-max">TOP TOPIC: -</div>
    </div>

    <script>
        // --- Configuration ---
        const DATA_URL = "https://raw.githubusercontent.com/stop6G/6G-arXiv/refs/heads/main/arxiv_6g_data.csv";
        const WORD_LIMIT = 250; 
        
        // Initialize download link with the correct URL
        document.getElementById('download-link').href = DATA_URL;

        // Modern "Cyber" Palette for dark mode
        const PALETTE = [
            "#ffffff", "#60a5fa", "#22d3ee", "#818cf8", "#c084fc", "#f472b6", "#38bdf8", "#94a3b8"
        ];

        // Custom stop words
        const STOP_WORDS = new Set([
            "a", "an", "the", "and", "of", "in", "on", "for", "to", "with", "by", "at", "from", 
            "is", "are", "was", "were", "be", "been", "being", "have", "has", "had", "do", "does", "did",
            "this", "that", "these", "those", "it", "its", "via", "based", "using", "towards", "toward",
            "study", "analysis", "approach", "method", "system", "systems", "network", "networks",
            "performance", "review", "survey", "overview", "application", "applications", "research",
            "paper", "proposed", "new", "novel", "design", "model", "modeling", "evaluation",
            "implementation", "optimization", "efficient", "improved", "enhanced", "experimental",
            "case", "comparative", "perspective", "future", "challenges", "opportunities", "issue", "issues",
            "scheme", "algorithm", "technique", "framework", "architecture", "protocol", "solution",
            "enabled", "driven", "defined", "centric", "integrated", "intelligent", "smart",
            "6g", "5g", "wireless", "communication", "communications", "mobile", "cellular"
        ]);

        // --- Elements ---
        const svgElement = d3.select("#word-cloud");
        const loadingEl = document.getElementById('loading');
        const statusText = document.getElementById('status-text');
        const statCount = document.getElementById('stat-count');
        const statMax = document.getElementById('stat-max');
        const statPapers = document.getElementById('stat-papers');
        const container = document.getElementById('viz-container');
        
        // Sidebar Elements
        const sidebar = document.getElementById('details-sidebar');
        const sidebarTitle = document.getElementById('sidebar-title');
        const sidebarCount = document.getElementById('sidebar-count');
        const sidebarContent = document.getElementById('sidebar-content');
        const closeSidebarBtn = document.getElementById('close-sidebar');

        // --- Initialization ---
        // Ensure fonts are loaded before starting to prevent bounding box errors (overlaps)
        window.addEventListener('load', () => {
            document.fonts.ready.then(fetchData);
        });
        
        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.add('translate-x-full');
            d3.select("#viz-container").classed("has-hover", false); // Remove dimming
            // Remove active state from all words
            svgElement.selectAll("text").style("opacity", 1).style("filter", "none");
        });

        // Resize handler
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (window.lastProcessedWords) {
                    generateCloud(window.lastProcessedWords);
                }
            }, 500);
        });

        // --- Logic ---

        async function fetchData() {
            try {
                statusText.textContent = "FETCHING CSV...";
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                statusText.textContent = "PARSING DATA...";
                setTimeout(() => processCSV(csvText), 100);
            } catch (err) {
                console.error(err);
                statusText.innerHTML = `<span class="text-red-500">ERROR: ${err.message}</span>`;
                loadingEl.querySelector('.loader').style.display = 'none';
            }
        }

        function processCSV(csvText) {
            try {
                const papers = extractData(csvText);
                if (papers.length === 0) throw new Error("No data found in CSV.");
                
                // Update total papers stat
                statPapers.textContent = `TOTAL PAPERS: ${papers.length}`;

                const wordCounts = countWords(papers);
                window.lastProcessedWords = wordCounts;
                
                generateCloud(wordCounts);
            } catch (err) {
                statusText.textContent = "Error: " + err.message;
            }
        }

        // Improved CSV Parser
        function extractData(csvText) {
            const lines = csvText.split(/\r?\n/);
            if (lines.length < 2) return [];

            const headerLine = lines[0];
            const header = headerLine.toLowerCase().split(',');
            
            const titleIdx = header.findIndex(h => h.trim().includes('title'));
            const summaryIdx = header.findIndex(h => h.trim().includes('summary'));
            const authorIdx = header.findIndex(h => h.trim().includes('author'));
            const linkIdx = header.findIndex(h => h.trim().includes('link'));
            const dateIdx = header.findIndex(h => h.trim().includes('published'));

            if (titleIdx === -1) throw new Error("Column 'title' not found.");

            const papers = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Robust manual CSV Parser logic
                const row = [];
                let currentStr = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(currentStr.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                        currentStr = '';
                    } else {
                        currentStr += char;
                    }
                }
                // Push the last field
                row.push(currentStr.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));

                if (row[titleIdx]) {
                    papers.push({
                        title: row[titleIdx],
                        summary: summaryIdx > -1 ? row[summaryIdx] : "No summary available.",
                        authors: authorIdx > -1 ? row[authorIdx] : "Unknown Authors",
                        link: linkIdx > -1 ? row[linkIdx] : "#",
                        date: dateIdx > -1 ? row[dateIdx] : ""
                    });
                }
            }
            return papers;
        }

        function countWords(papers) {
            const counts = {};
            let maxCount = 0;
            let topWord = '';

            papers.forEach(paper => {
                const words = paper.title.toLowerCase()
                    .replace(/[^\w\s-]/g, '')
                    .split(/\s+/);

                words.forEach(word => {
                    word = word.replace(/^-+|-+$/g, '');
                    if (word.length > 2 && !STOP_WORDS.has(word) && !/^\d+$/.test(word)) {
                        
                        if (!counts[word]) {
                            counts[word] = { value: 0, papers: [] };
                        }
                        
                        counts[word].value++;
                        counts[word].papers.push(paper); // Link paper to word

                        if (counts[word].value > maxCount) {
                            maxCount = counts[word].value;
                            topWord = word;
                        }
                    }
                });
            });

            statCount.textContent = `WORDS: ${Object.keys(counts).length}`;
            statMax.textContent = `TOP TOPIC: ${topWord.toUpperCase()} (${maxCount})`;

            return Object.entries(counts)
                .map(([text, data]) => ({ 
                    text, 
                    value: data.value, 
                    papers: data.papers 
                }))
                .sort((a, b) => b.value - a.value)
                .slice(0, WORD_LIMIT);
        }

        function generateCloud(words) {
            const rect = container.getBoundingClientRect();
            const width = rect.width; 
            const height = rect.height;

            svgElement.selectAll("*").remove();

            if (words.length === 0) return;

            const maxVal = words[0].value;
            const minVal = words[words.length - 1].value;
            
            const isMobile = width < 600;
            const baseSize = isMobile ? 8 : 10; 
            const maxSize = isMobile ? 40 : 70; // Reduced max from 80 to 70 for better shape

            const fontScale = d3.scalePow().exponent(0.8)
                .domain([minVal, maxVal])
                .range([baseSize, maxSize]);

            const layout = d3.layout.cloud()
                .size([width, height])
                .words(words)
                .padding(5) // Back to tight padding
                .rotate(() => 0) 
                .font("Inter") // Font is now guaranteed loaded
                .fontWeight(d => d.value > maxVal * 0.4 ? 800 : 400)
                .fontSize(d => fontScale(d.value))
                .on("end", draw);

            layout.start();

            function draw(drawnWords) {
                loadingEl.style.opacity = '0';
                setTimeout(() => loadingEl.style.display = 'none', 500);
                document.getElementById('word-cloud').style.opacity = '1';

                const g = svgElement
                    .attr("viewBox", `0 0 ${width} ${height}`)
                    .append("g")
                    .attr("transform", `translate(${width / 2},${height / 2})`);

                const texts = g.selectAll("text")
                    .data(drawnWords)
                    .enter().append("text")
                    .style("font-size", "0px")
                    .style("font-family", "Inter")
                    .style("dominant-baseline", "central") // Fixes vertical alignment for click accuracy
                    .style("fill", (d, i) => {
                         if (i < 5) return PALETTE[i + 1];
                         if (i < 30) return "#ffffff";
                         return "#94a3b8";
                    })
                    .attr("text-anchor", "middle")
                    .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                    .text(d => d.text)
                    .attr("class", "hover:z-50")
                    .on("mouseover", function(event, d) {
                        if (!sidebar.classList.contains('translate-x-full')) return;
                        d3.select("#viz-container").classed("has-hover", true);
                        d3.select(this).raise(); // Brings the hovered word to front (DOM order) so it captures clicks
                    })
                    .on("mouseout", function() {
                        if (!sidebar.classList.contains('translate-x-full')) return;
                        d3.select("#viz-container").classed("has-hover", false);
                    })
                    .on("click", function(event, d) {
                        event.stopPropagation();
                        showPaperDetails(d);
                    });
                
                texts.transition()
                    .duration(800)
                    .delay((d, i) => i * 5)
                    .ease(d3.easeBackOut)
                    .style("font-size", d => `${d.size}px`);

                texts.append("title").text(d => `Click to see ${d.value} papers about "${d.text}"`);
            }
        }

        function showPaperDetails(wordData) {
            // Update Sidebar Header
            sidebarTitle.textContent = wordData.text;
            sidebarCount.textContent = `Found in ${wordData.value} titles`;

            // Clear old content
            sidebarContent.innerHTML = '';

            // Generate list
            const fragment = document.createDocumentFragment();
            
            // Deduplicate papers by title just in case
            const uniquePapers = Array.from(new Set(wordData.papers.map(p => p.title)))
                .map(title => wordData.papers.find(p => p.title === title));

            uniquePapers.forEach(paper => {
                const card = document.createElement('div');
                card.className = "paper-card p-4 rounded-xl border border-white/5 bg-white/5 mb-3";
                
                const safeTitle = paper.title.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                const safeAuthors = paper.authors.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                // Clean up date (YYYY-MM-DD)
                const dateStr = paper.date.split('T')[0] || "Unknown Date";

                card.innerHTML = `
                    <h3 class="font-bold text-sm text-gray-200 mb-2 leading-snug">${safeTitle}</h3>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-[10px] font-mono bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded">${dateStr}</span>
                    </div>
                    <p class="text-xs text-gray-400 mb-3 line-clamp-2">${safeAuthors}</p>
                    <a href="${paper.link}" target="_blank" class="inline-flex items-center text-xs font-semibold text-blue-400 hover:text-blue-300 transition-colors">
                        READ PAPER 
                        <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </a>
                `;
                fragment.appendChild(card);
            });

            sidebarContent.appendChild(fragment);

            // Open Sidebar
            sidebar.classList.remove('translate-x-full');
        }

        // Close sidebar if clicking outside words area
        container.addEventListener('click', (e) => {
            if (e.target.id === 'viz-container' || e.target.nodeName === 'svg') {
                sidebar.classList.add('translate-x-full');
                d3.select("#viz-container").classed("has-hover", false);
            }
        });

    </script>
</body>
</html>